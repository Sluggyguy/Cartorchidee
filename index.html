<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartographie d'Orchid√©es avec Photos</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <!-- EXIF.js for reading image metadata -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <style>
        /* Basic Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #4A7C59; /* Greenish color */
            color: white;
            padding: 1em;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .main-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
        }

        #map-column {
            flex: 4;
            min-width: 400px;
            display: flex;
            flex-direction: column;
        }

        #map {
            height: 500px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .map-instructions {
            font-size: 0.9em;
            color: #555;
            margin-top: 8px;
            text-align: center;
        }


        #form-column {
            flex: 1.1;
            min-width: 390px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-left: 40px;
        }

        .form-section {
            background: #fafbfc;
            border: 1px solid #e0e4ea;
            border-radius: 8px;
            padding: 9px 7px 5px 7px;
            margin-bottom: 7px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            max-width: 390px;
        }
        .entries-section {
            background: #fafbfc;
            border: 1px solid #e0e4ea;
            border-radius: 8px;
            padding: 9px 7px 5px 7px;
            margin-bottom: 7px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            max-width: 100%;
        }
        .form-section h2 {
            font-size: 1em;
            margin-bottom: 7px;
            margin-top: 0;
            letter-spacing: 0.01em;
            color: #4A7C59;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 2px;
        }
        .form-section form > div {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        .form-section label {
            min-width: 90px;
            font-size: 0.90em;
            margin-right: 5px;
            color: #333;
        }
        .form-section input[type="text"],
        .form-section input[type="number"],
        .form-section input[type="file"] {
            min-width: 210px;
            width: 100%;
            max-width: 400px;
            font-size: 0.97em;
            padding: 4px 6px;
            background: #fff;
            box-sizing: border-box;
            overflow: visible;
        }
        .form-section select,
        .form-section textarea {
            flex: 1 1 0;
            padding: 3px 6px;
            font-size: 0.90em;
            border-radius: 5px;
            border: 1px solid #ccd3db;
            background: #fff;
            box-sizing: border-box;
            margin: 0;
        }
        .form-section textarea {
            min-height: 28px;
            max-height: 50px;
        }
        @media (max-width: 600px) {
            .form-section {
                max-width: 99vw;
                padding: 5px 1vw 4px 1vw;
            }
            .form-section label {
                min-width: 60px;
                font-size: 0.90em;
            }
            .form-section form > div {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 4px;
            }
            .form-section input,
            .form-section select,
            .form-section textarea {
                width: 100%;
                margin-top: 2px;
            }
        }

        .entries-section h2 {
            margin-top: 0;
            color: #4A7C59;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            font-size: 1.4em;
        }

        /* Form elements styling */
        #orchid-form div {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        textarea {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box; /* Important for width calculation */
            font-size: 1em;
        }
        input[type="file"] {
            padding: 7px; /* Specific padding for file input */
        }


        textarea {
            resize: vertical;
            min-height: 80px;
        }

        #orchid-form button[type="submit"] {
            padding: 12px 20px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        #orchid-form button[type="submit"]:hover {
            background-color: #4cae4c;
        }

        #photo-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }
        #clear-photo-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 5px;
            display: none; /* Hidden by default */
        }
        #clear-photo-btn:hover {
            background-color: #e67e22;
        }


        /* Table styling */
        #entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #entries-table th, #entries-table td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
            vertical-align: middle;
        }

        #entries-table th {
            background-color: #f9f9f9;
            color: #333;
            font-weight: 600;
        }

        #entries-table tbody tr:nth-child(odd) {
            background-color: #fdfdfd;
        }
        #entries-table tbody tr:hover {
            background-color: #f0f0f0;
        }
         #entries-table .photo-thumbnail {
            max-width: 50px;
            max-height: 50px;
            border-radius: 4px;
            cursor: pointer;
        }


        .action-buttons button {
            margin-right: 5px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.2s ease;
        }

        .edit-btn {
            background-color: #3498db; /* Blue */
            color: white;
        }
        .edit-btn:hover {
            background-color: #2980b9;
        }

        .delete-btn {
            background-color: #e74c3c; /* Red */
            color: white;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }

        .no-entries-message td {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }

        /* Pink marker style (using L.DivIcon) */
        .custom-pink-dot-icon div {
            background-color: deeppink;
            width: 14px; /* Slightly larger */
            height: 14px;
            border-radius: 50%;
            border: 2px solid white; /* White border for better visibility */
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        /* Popup image style */
        .popup-image {
            max-width: 200px;
            max-height: 200px;
            display: block;
            margin-top: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }


        footer {
            text-align: center;
            padding: 15px;
            background-color: #333;
            color: #aaa;
            font-size: 0.9em;
            margin-top: auto; /* Pushes footer to the bottom */
        }
        #loading-message {
            display: none;
            color: #4A7C59;
            font-style: italic;
            margin-top: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            #map-column, #form-column {
                flex: 1; /* Stack them */
                width: 100%;
            }
            header h1 {
                font-size: 1.5em;
            }
             #orchid-form button[type="submit"] {
                font-size: 0.95em;
            }
            .action-buttons button {
                 font-size: 0.8em;
                 padding: 5px 8px;
            }
            #entries-table th, #entries-table td {
                padding: 8px;
                font-size: 0.85em;
            }
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 1.5em;
            background: #fafbfc;
        }
        .tab-btn {
            padding: 12px 28px;
            border: none;
            background: none;
            font-size: 1.1em;
            cursor: pointer;
            outline: none;
            border-bottom: 3px solid transparent;
            transition: border-color 0.2s, background 0.2s;
        }
        .tab-btn.active {
            border-bottom: 3px solid #5cb85c;
            background: #f0f8f0;
            color: #333;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
    <script>
    // Gestion dynamique des onglets (tabs) - doit √™tre d√©fini AVANT tout appel onclick
    window.showTab = function(tab) {
        document.getElementById('tab-map').classList.remove('active');
        document.getElementById('tab-table').classList.remove('active');
        document.getElementById('tab-map-btn').classList.remove('active');
        document.getElementById('tab-table-btn').classList.remove('active');
        if(tab === 'map') {
            document.getElementById('tab-map').classList.add('active');
            document.getElementById('tab-map-btn').classList.add('active');
            setTimeout(function() {
                if (typeof map !== 'undefined') {
                    map.invalidateSize();
                }
            }, 150);
        } else {
            document.getElementById('tab-table').classList.add('active');
            document.getElementById('tab-table-btn').classList.add('active');
            if (typeof renderTable === 'function') {
                renderTable();
            }
        }
    }
    </script>
</head>
<body>
    <!-- Onglets navigation -->
    <div class="tabs-container">
        <button class="tab-btn active" id="tab-map-btn" onclick="showTab('map')">Carte & Ajout</button>
        <button class="tab-btn" id="tab-table-btn" onclick="showTab('table')">Tableau des observations</button>
    </div>
    <div id="tab-map" class="tab-content active">
        <header>
            <h1>üå∑ CartoMel üå∑</h1>
        </header>
        <div class="main-container">
            <div id="map-column">
                <div id="map"></div>
                <p class="map-instructions">Cliquez sur la carte pour obtenir les coordonn√©es ou chargez une photo avec GPS.</p>
            </div>
            <div id="form-column">
                <section class="form-section">
                    <h2>Ajouter/Modifier une Observation</h2>
                    <form id="orchid-form">
                        <div>
                            <label for="photoFile">Photo (JPEG/PNG, optionnel):</label>
                            <input type="file" id="photoFile" name="photoFile" accept="image/jpeg, image/png">
                            <img id="photo-preview" src="#" alt="Aper√ßu photo"/>
                            <button type="button" id="clear-photo-btn">Retirer la photo</button>
                            <p id="loading-message">Extraction des donn√©es GPS...</p>
                        </div>
                        <div>
                            <label for="genus">Genre&nbsp;:</label>
                            <select id="genus" name="genus" required>
                                <option value="">-- Choisir un genre --</option>
                                <option value="Anacamptis">Anacamptis</option>
                                <option value="Dactylorhiza">Dactylorhiza</option>
                                <option value="Epipactis">Epipactis</option>
                                <option value="Goodyera">Goodyera</option>
                                <option value="Gymnadenia">Gymnadenia</option>
                                <option value="Hammarbya">Hammarbya</option>
                                <option value="Himantoglossum">Himantoglossum</option>
                                <option value="Neottia">Neottia</option>
                                <option value="Ophrys">Ophrys</option>
                                <option value="Orchis">Orchis</option>
                                <option value="Platanthera">Platanthera</option>
                                <option value="Serapias">Serapias</option>
                                <option value="Spiranthes">Spiranthes</option>
                            </select>
                        </div>
                        <div>
    <label for="species">Esp√®ce&nbsp;:</label>
    <select id="species" name="species" required>
        <option value="">-- Choisir une esp√®ce --</option>
    </select>
</div>
<div>
    <label for="Pieds">Nombre de pieds&nbsp;:</label>
    <input type="number" id="Pieds" name="Pieds" min="0" step="1" placeholder="Nombre observ√© (optionnel)">
</div>
                        <div>
                            <label for="latitude">Latitude:</label>
                            <input type="text" id="latitude" name="latitude" required placeholder="Ex: 48.1173">
                        </div>
                        <div>
                            <label for="longitude">Longitude:</label>
                            <input type="text" id="longitude" name="longitude" required placeholder="Ex: -1.6778">
                        </div>
                        <div>
                            <label for="commune">Commune (auto):</label>
                            <input type="text" id="commune" name="commune" readonly placeholder="Recherche automatique...">
                        </div>
                        <div>
                            <label for="date">Date:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div>
                            <label for="√âtat de Floraison">√âtat de Floraison :</label>
                            <textarea id="√âtat de Floraison" name="√âtat de Floraison" placeholder="Ex : en bouton, d√©but floraison, pleine floraison, fin, fan√©e..."></textarea>
                        </div>
                        <input type="hidden" id="entry-id"> <!-- For editing -->
                        <input type="hidden" id="photoDataURL"> <!-- To store photo data URL -->
                        <button type="submit">Sauvegarder l'Observation</button>
                    </form>
                </section>
            </div>
        </div>
    </div>
    <div id="tab-table" class="tab-content">
        <section class="entries-section">
            <h2>Tableau des observations</h2>
            <div style="display:flex;gap:6px;align-items:center;margin-bottom:10px;">
                <input type="text" id="search-table" placeholder="Rechercher..." style="width:300px;max-width:100%">
                <button id="btn-search-table" title="Rechercher" style="padding:4px 9px;">üîç</button>
                <button id="btn-clear-search-table" title="Effacer la recherche" style="padding:4px 9px;">‚ùå</button>
            </div>
            <div style="overflow-x:auto;"> <!-- For table responsiveness -->
                <table id="entries-table">
                    <thead>
                        <tr>
                            <th>Photo</th>
<th>Genre</th>
<th>Esp√®ce</th>
<th>Pieds</th>
<th>Date</th>
<th>Lat.</th>
<th>Lon.</th>
<th>Commune</th>
<th>√âtat de Floraison</th>
<th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les donn√©es seront ins√©r√©es ici par JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>
                            <!-- Les donn√©es seront ins√©r√©es ici par JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <p>&copy; 2024-2025 Cartographie d'Orchid√©es. Tous droits r√©serv√©s.</p>
    </footer>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
    // Gestion dynamique des onglets
    window.showTab = function(tab) {
        document.getElementById('tab-map').classList.remove('active');
        document.getElementById('tab-table').classList.remove('active');
        document.getElementById('tab-map-btn').classList.remove('active');
        document.getElementById('tab-table-btn').classList.remove('active');
        if(tab === 'map') {
            document.getElementById('tab-map').classList.add('active');
            document.getElementById('tab-map-btn').classList.add('active');
            // Force map resize when tab is shown
            setTimeout(function() {
                if (typeof map !== 'undefined') {
                    map.invalidateSize();
                }
            }, 150);
        } else {
            document.getElementById('tab-table').classList.add('active');
            document.getElementById('tab-table-btn').classList.add('active');
            // Optionally re-render table for freshness
            if (typeof renderTable === 'function') {
                renderTable();
            }
        }
    }

        // --- MAP INITIALIZATION ---
        const map = L.map('map').setView([48.1173, -1.6778], 7); // Rennes, France
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        tileLayer.addTo(map);

        // --- GLOBAL VARIABLES ---
        let orchidData = [];
        let editingEntryId = null;
        let currentEditId = null;
        const form = document.getElementById('orchid-form');
        const genusInput = document.getElementById('genus');
        const speciesInput = document.getElementById('species');
        const communeInput = document.getElementById('commune');

// Dictionnaire genre -> esp√®ces
const genusSpeciesMap = {
    "Anacamptis": [
        "Anacamptis coriophora",
        "Anacamptis laxiflora",
        "Anacamptis morio",
        "Anacamptis pyramidalis"
    ],
    "Dactylorhiza": [
        "Dactylorhiza fuchsii",
        "Dactylorhiza incarnata",
        "Dactylorhiza maculata",
        "Dactylorhiza maculata var. elodes",
        "Dactylorhiza maculata var. ericetorum",
        "Dactylorhiza praetermissa",
        "Dactylorhiza viridis"
    ],
    "Epipactis": [
        "Epipactis helleborine",
        "Epipactis neerlandica",
        "Epipactis palustris"
    ],
    "Goodyera": ["Goodyera repens"],
    "Gymnadenia": ["Gymnadenia conopsea"],
    "Hammarbya": ["Hammarbya paludosa"],
    "Himantoglossum": [
        "Himantoglossum hircinum",
        "Himantoglossum robertianum"
    ],
    "Neottia": [
        "Neottia nidus-avis",
        "Neottia ovata"
    ],
    "Ophrys": [
        "Ophrys apifera",
        "Ophrys apifera var. trollii",
        "Ophrys aranifera/sphegodes",
        "Ophrys funerea/sulcata/zonata",
        "Ophrys speculum"
    ],
    "Orchis": [
        "Orchis anthropophora",
        "Orchis mascula"
    ],
    "Platanthera": [
        "Platanthera bifolia & fornicata",
        "Platanthera chlorantha"
    ],
    "Serapias": [
        "Serapias lingua",
        "Serapias parviflora"
    ],
    "Spiranthes": [
        "Spiranthes aestivalis",
        "Spiranthes spiralis"
    ]
};
// Mise √† jour dynamique du menu d√©roulant des esp√®ces
function updateSpeciesOptions() {
    const selectedGenus = genusInput.value;
    speciesInput.innerHTML = '<option value="">-- Choisir une esp√®ce --</option>';
    if (genusSpeciesMap[selectedGenus]) {
        genusSpeciesMap[selectedGenus].forEach(function(species) {
            const option = document.createElement('option');
            option.value = species;
            option.textContent = species;
            speciesInput.appendChild(option);
        });
    }
}
if (genusInput && speciesInput) {
    genusInput.addEventListener('change', updateSpeciesOptions);
    document.addEventListener('DOMContentLoaded', function() {
        updateSpeciesOptions();
    });
}

        // Gestion dynamique des onglets (tabs)
        window.showTab = function(tab) {
            document.getElementById('tab-map').classList.remove('active');
            document.getElementById('tab-table').classList.remove('active');
            document.getElementById('tab-map-btn').classList.remove('active');
            document.getElementById('tab-table-btn').classList.remove('active');
            if(tab === 'map') {
                document.getElementById('tab-map').classList.add('active');
                document.getElementById('tab-map-btn').classList.add('active');
                setTimeout(function() {
                    if (typeof map !== 'undefined') {
                        map.invalidateSize();
                    }
                }, 150);
            } else {
                document.getElementById('tab-table').classList.add('active');
                document.getElementById('tab-table-btn').classList.add('active');
                if (typeof renderTable === 'function') {
                    renderTable();
                }
            }
        }


        // Fonction pour remplir automatiquement la commune en fonction des coordonn√©es GPS
        async function updateCommuneField(lat, lon) {
            if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
                communeInput.value = '';
                return;
            }
            communeInput.value = 'Recherche...';
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=fr`;
                const response = await fetch(url, { headers: { 'User-Agent': 'CartomelApp/1.0 contact@cartomel.local' } });
                const data = await response.json();
                if (data && data.address && (data.address.village || data.address.town || data.address.city || data.address.municipality || data.address.county)) {
                    communeInput.value = data.address.village || data.address.town || data.address.city || data.address.municipality || data.address.county || '';
                } else {
                    communeInput.value = '';
                }
            } catch (err) {
                communeInput.value = '';
            }
        }
        const entriesTableBody = document.getElementById('entries-table').getElementsByTagName('tbody')[0];
        let markersLayer = L.layerGroup().addTo(map);
        const photoFileInput = document.getElementById('photoFile');
        const photoPreview = document.getElementById('photo-preview');
        const photoDataURLInput = document.getElementById('photoDataURL');
        const clearPhotoButton = document.getElementById('clear-photo-btn');
        const loadingMessage = document.getElementById('loading-message');
        // Les variables li√©es √† l'import JSON et au dossier de sauvegarde ont √©t√© supprim√©es car inutiles

        // --- CUSTOM PINK MARKER ICON ---
        const pinkDotIcon = L.divIcon({
            className: 'custom-pink-dot-icon',
            html: '<div></div>',
            iconSize: [14, 14],
            iconAnchor: [7, 7]
        });

        // --- HELPER FUNCTION to convert GPS DMS to Decimal Degrees ---
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            if (degrees === undefined || minutes === undefined || seconds === undefined || direction === undefined) {
                return null;
            }
            let dd = Math.abs(degrees) + minutes / 60 + seconds / 3600;
            if (direction === "S" || direction === "W") dd = -dd;
            if (direction === "E" || direction === "N") dd = Math.abs(dd);
            return dd;
        }

        // --- PHOTO HANDLING ---
        photoFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                loadingMessage.style.display = 'block';
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoDataURLInput.value = e.target.result; // Store Data URL
                    clearPhotoButton.style.display = 'inline-block';
                }
                reader.readAsDataURL(file);

                if (editingEntryId === null || editingEntryId === undefined || editingEntryId === '') {
            // AJOUT : Extraction GPS autoris√©e
            console.log('[PHOTO] Mode AJOUT : extraction GPS activ√©e');
            EXIF.getData(file, function() {
                        loadingMessage.style.display = 'none';
                        const latArr = EXIF.getTag(this, "GPSLatitude");
                        const lonArr = EXIF.getTag(this, "GPSLongitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

                        if (latArr && lonArr && latRef && lonRef) {
                            const latitude = convertDMSToDD(latArr[0], latArr[1], latArr[2], latRef);
                            const longitude = convertDMSToDD(lonArr[0], lonArr[1], lonArr[2], lonRef);

                            console.log('EXIF Latitude:', latArr, latRef, '‚Üí', latitude);
                            console.log('EXIF Longitude:', lonArr, lonRef, '‚Üí', longitude);

                            if (latitude !== null && longitude !== null) {
                                document.getElementById('latitude').value = latitude.toFixed(5);
                                document.getElementById('longitude').value = longitude.toFixed(5);
                                updateCommuneField(latitude, longitude);
                                alert("Coordonn√©es GPS extraites de la photo et ins√©r√©es.");
                            } else {
                               alert("Impossible de convertir les coordonn√©es GPS de la photo.");
                            }
                        } else {
                            alert("Aucune donn√©e GPS trouv√©e dans cette image. Veuillez les entrer manuellement ou cliquer sur la carte.");
                        }
                    });
                } else {
            // EDITION : Extraction GPS INTERDITE
            console.log('[PHOTO] Mode EDITION : extraction GPS d√©sactiv√©e, aucune modification des coordonn√©es.', editingEntryId);
            loadingMessage.style.display = 'none';
        }
    } else {
                 resetPhotoFields();
            }
        });
        
        clearPhotoButton.addEventListener('click', function() {
            resetPhotoFields();
        });

        function resetPhotoFields() {
            photoFileInput.value = ''; // Clear file input
            photoPreview.src = '#';
            photoPreview.style.display = 'none';
            photoDataURLInput.value = '';
            clearPhotoButton.style.display = 'none';
            loadingMessage.style.display = 'none';
        }

        // --- EVENT LISTENERS ---
        // Recherche dans le tableau et sur la carte
        function doSearchTable() {
            const query = document.getElementById('search-table').value.trim().toLowerCase();
            if (!query) {
                filteredData = orchidData;
            } else {
                filteredData = orchidData.filter(entry => {
                    return (
                        (entry.espece && entry.espece.toLowerCase().includes(query)) ||
                        (entry.Commune && entry.Commune.toLowerCase().includes(query)) ||
                        (entry.commune && entry.commune.toLowerCase().includes(query)) ||
                        (entry.notes && entry.notes.toLowerCase().includes(query)) ||
                        (entry.date && formatDateFR(entry.date).includes(query)) ||
                        (entry.lat && String(entry.lat).includes(query)) ||
                        (entry.lon && String(entry.lon).includes(query))
                    );
                });
            }
            renderTable(filteredData);
            renderMapMarkers(filteredData);
        }
        document.getElementById('btn-search-table').addEventListener('click', doSearchTable);
        document.getElementById('search-table').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') doSearchTable();
        });
        document.getElementById('btn-clear-search-table').addEventListener('click', function() {
            document.getElementById('search-table').value = '';
            filteredData = orchidData;
            renderTable(filteredData);
            renderMapMarkers(filteredData);
        });

        // Mise √† jour automatique de la commune lors de la saisie manuelle des coordonn√©es
        document.getElementById('latitude').addEventListener('change', function() {
            const lat = parseFloat(this.value.replace(',', '.'));
            const lon = parseFloat(document.getElementById('longitude').value.replace(',', '.'));
            if (!isNaN(lat) && !isNaN(lon)) {
                updateCommuneField(lat, lon);
            }
        });
        document.getElementById('longitude').addEventListener('change', function() {
            const lat = parseFloat(document.getElementById('latitude').value.replace(',', '.'));
            const lon = parseFloat(this.value.replace(',', '.'));
            if (!isNaN(lat) && !isNaN(lon)) {
                updateCommuneField(lat, lon);
            }
        });

        
clearPhotoButton.addEventListener('click', function() {
    resetPhotoFields();
    window.photoDeleted = true;
});

function resetPhotoFields() {
    photoFileInput.value = ''; // Clear file input
    photoPreview.src = '#';
    photoPreview.style.display = 'none';
    photoDataURLInput.value = '';
    clearPhotoButton.style.display = 'none';
    loadingMessage.style.display = 'none';
    window.photoDataURL = '';
    window.photoDeleted = false;
}

// --- EVENT LISTENERS ---
// Recherche dans le tableau et sur la carte
function doSearchTable() {
    const query = document.getElementById('search-table').value.trim().toLowerCase();
    if (!query) {
        filteredData = orchidData;
    } else {
        filteredData = orchidData.filter(entry => {
            return (
                (entry.espece && entry.espece.toLowerCase().includes(query)) ||
                (entry.Commune && entry.Commune.toLowerCase().includes(query)) ||
                (entry.commune && entry.commune.toLowerCase().includes(query)) ||
                (entry["√âtat de Floraison"] && entry["√âtat de Floraison"].toLowerCase().includes(query)) ||
                (entry.date && formatDateFR(entry.date).includes(query)) ||
                (entry.lat && String(entry.lat).includes(query)) ||
                (entry.lon && String(entry.lon).includes(query))
            );
        });
    }
    renderTable(filteredData);
    renderMapMarkers(filteredData);
}
document.getElementById('btn-search-table').addEventListener('click', doSearchTable);
document.getElementById('search-table').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doSearchTable();
});
document.getElementById('btn-clear-search-table').addEventListener('click', function() {
    document.getElementById('search-table').value = '';
    filteredData = orchidData;
    renderTable(filteredData);
    renderMapMarkers(filteredData);
});

// Mise √† jour automatique de la commune lors de la saisie manuelle des coordonn√©es
document.getElementById('latitude').addEventListener('change', function() {
    const lat = parseFloat(this.value.replace(',', '.'));
    const lon = parseFloat(document.getElementById('longitude').value.replace(',', '.'));
    if (!isNaN(lat) && !isNaN(lon)) {
        updateCommuneField(lat, lon);
    } else {
        // Ne rien faire : ne jamais vider commune automatiquement
    }
});
document.getElementById('longitude').addEventListener('change', function() {
    const lat = parseFloat(document.getElementById('latitude').value.replace(',', '.'));
    const lon = parseFloat(this.value.replace(',', '.'));
    if (!isNaN(lat) && !isNaN(lon)) {
        updateCommuneField(lat, lon);
    } else {
        // Ne rien faire : ne jamais vider commune automatiquement
    }
});
form.addEventListener('submit', async function(event) {
    event.preventDefault();

    const genre = document.getElementById('genus').value;
    const espece = document.getElementById('species').value;
    const date = document.getElementById('date').value;
    const latValue = String(document.getElementById('latitude').value).replace(',', '.');
    const lonValue = String(document.getElementById('longitude').value).replace(',', '.');
    const lat = latValue !== '' ? parseFloat(latValue) : '';
    const lon = lonValue !== '' ? parseFloat(lonValue) : '';
    const commune = document.getElementById('commune').value.trim();
    const etatFloraison = document.getElementById('√âtat de Floraison').value.trim();
    const id = editingEntryId || Math.random().toString(36).substr(2, 5).toUpperCase();
    const photoDataURL = window.photoDataURL || '';

    if (!genre || !espece || !date || isNaN(lat) || isNaN(lon)) {
        alert('Merci de remplir tous les champs obligatoires.');
        return;
    }

    let photoURL = '';
    if (window.photoDeleted) {
        photoURL = '';
    } else if (photoDataURL) {
        try {
            photoURL = await uploadToImgur(photoDataURL);
        } catch (err) {
            alert("Erreur d'upload de la photo : " + err.message);
            if (err.response) {
                console.error('R√©ponse compl√®te Imgur:', err.response);
            }
            return;
        }
    } else {
        photoURL = (editingEntryId ? (orchidData.find(e => e.id === id)?.photoURL || '') : '');
    }
    const entry = { id, genre, espece, date, lat, lon, photoURL };
    entry["Pieds"] = document.getElementById('Pieds').value;
    entry["√âtat de Floraison"] = document.getElementById('√âtat de Floraison').value;
const entryForSheetDB = {
  id,
  genre,
  espece,
  date,
  lat,
  lon,
  Pieds: document.getElementById('Pieds').value.trim(),
  Commune: commune,
  "√âtat de Floraison": etatFloraison,
  photoURL
};

    if (editingEntryId) {
        await updateEntryInSheetDB(entryForSheetDB);
        const idx = orchidData.findIndex(e => e.id === id);
        if (idx !== -1) orchidData[idx] = entry;
        editingEntryId = null;
    } else {
        await addEntryToSheetDB(entryForSheetDB);
        orchidData.push(entry);
    }

    renderTable();
    renderMapMarkers();
    resetPhotoFields();
    form.reset();
    window.photoDataURL = '';
    window.photoDeleted = false;
    document.getElementById('photoDataURL').value = '';
});

// Gestion de la s√©lection de la photo : stocke le DataURL dans une variable globale
document.getElementById('photoFile').addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (file) {
        try {
            const compressedDataURL = await compressImage(file, 0.7, 1600, 1600);
            window.photoDataURL = compressedDataURL;
            document.getElementById('photoDataURL').value = compressedDataURL;

            // Extraction GPS UNIQUEMENT si on n'est PAS en √©dition
            if (!editingEntryId) {
                EXIF.getData(file, function() {
                    const latArr = EXIF.getTag(this, "GPSLatitude");
                    const lonArr = EXIF.getTag(this, "GPSLongitude");
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                    if (latArr && lonArr && latRef && lonRef) {
                        const latitude = convertDMSToDD(latArr[0], latArr[1], latArr[2], latRef);
                        const longitude = convertDMSToDD(lonArr[0], lonArr[1], lonArr[2], lonRef);
                        if (latitude !== null && longitude !== null) {
                            document.getElementById('latitude').value = latitude.toFixed(5);
                            document.getElementById('longitude').value = longitude.toFixed(5);
                            updateCommuneField(latitude, longitude);
                            alert("Coordonn√©es GPS extraites de la photo et ins√©r√©es.");
                        } else {
                            alert("Impossible de convertir les coordonn√©es GPS de la photo.");
                        }
                    } else {
                        // Pas de GPS dans la photo
                        // alert("Aucune donn√©e GPS trouv√©e dans cette image. Veuillez les entrer manuellement ou cliquer sur la carte.");
                    }
                });
            }
        } catch (err) {
            alert('Erreur lors de la compression de la photo : ' + err.message);
            window.photoDataURL = '';
            document.getElementById('photoDataURL').value = '';
        }
    } else {
        window.photoDataURL = '';
        document.getElementById('photoDataURL').value = '';
    }
});

// Fonction de compression automatique d'image (JPEG)
function compressImage(file, quality = 0.7, maxWidth = 1600, maxHeight = 1600) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
        };
        img.onload = function() {
            let width = img.width;
            let height = img.height;
            if (width > maxWidth || height > maxHeight) {
                if (width > height) {
                    height = Math.round(height * maxWidth / width);
                    width = maxWidth;
                } else {
                    width = Math.round(width * maxHeight / height);
                    height = maxHeight;
                }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(blob => {
                const reader2 = new FileReader();
                reader2.onload = function(e2) {
                    resolve(e2.target.result); // DataURL compress√©e
                };
                reader2.onerror = reject;
                reader2.readAsDataURL(blob);
            }, 'image/jpeg', quality);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Fonction d'upload sur Imgur
async function uploadToImgur(base64Image) {
    const response = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: {
            Authorization: 'Client-ID 96306b07074447f'
        },
        body: new URLSearchParams({ image: base64Image.split(',')[1] })
    });
    const data = await response.json();
    if (!data.success) {
        const err = new Error(data.data?.error || 'Erreur Imgur');
        err.response = data;
        throw err;
    }
    return data.data.link;
}

map.on('click', async function(e) {
    document.getElementById('latitude').value = e.latlng.lat.toFixed(5);
    document.getElementById('longitude').value = e.latlng.lng.toFixed(5);
    await updateCommuneField(e.latlng.lat, e.latlng.lng);
});

// --- TABLE RENDERING ---
// Permet de filtrer les donn√©es affich√©es
let filteredData = undefined;

function renderTable(data) {
    data = data || filteredData || orchidData;

    entriesTableBody.innerHTML = '';

    if (!data || data.length === 0) {
        const row = entriesTableBody.insertRow();
        row.classList.add('no-entries-message');
        const cell = row.insertCell();
        cell.colSpan = 8; // 8 colonnes avec Photo et Actions
        cell.textContent = "Aucune observation enregistr√©e pour le moment.";
        return;
    }
    
    const sortedData = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));

    sortedData.forEach(entry => {
        const row = entriesTableBody.insertRow();
        // Photo
        const photoCell = row.insertCell();
        if (entry.photoURL) {
            const img = document.createElement('img');
            img.src = entry.photoURL;
            img.alt = `Photo de ${entry.espece}`;
            img.className = 'photo-thumbnail';
            img.onclick = () => {
                const imageWindow = window.open("", "_blank");
                imageWindow.document.write(`<img src=\"${entry.photoURL}\" style=\"max-width:100%; max-height:100vh;\" alt=\"Photo de ${entry.espece}\">`);
            };
            photoCell.appendChild(img);
        } else {
            photoCell.textContent = '-';
        }
        // Genre
        const genreCell = row.insertCell();
        genreCell.textContent = entry.genre || '-';
        // Esp√®ce
        const especeCell = row.insertCell();
        especeCell.textContent = entry.espece || '-';
        // Pieds
        const piedsCell = row.insertCell();
        piedsCell.textContent = (entry["Pieds"] !== undefined && entry["Pieds"] !== null && entry["Pieds"] !== '') ? entry["Pieds"] : '-';
        // Date
        const dateCell = row.insertCell();
        dateCell.textContent = formatDateFR(entry.date) || '-';
        // Latitude
        const latCell = row.insertCell();
        latCell.textContent = (typeof entry.lat === 'number' && !isNaN(entry.lat)) ? entry.lat.toFixed(5) : '-';
        // Longitude
        const lonCell = row.insertCell();
        lonCell.textContent = (typeof entry.lon === 'number' && !isNaN(entry.lon)) ? entry.lon.toFixed(5) : '-';
        // Commune
        const communeCell = row.insertCell();
        communeCell.textContent = entry.commune || entry.Commune || '-';
        // √âtat de Floraison
        const floraisonCell = row.insertCell();
        floraisonCell.textContent = entry["√âtat de Floraison"] || '-';
        floraisonCell.style.maxWidth = '150px';
        floraisonCell.style.whiteSpace = 'nowrap';
        floraisonCell.style.overflow = 'hidden';
        floraisonCell.style.textOverflow = 'ellipsis';
        if (entry["√âtat de Floraison"]) {
            floraisonCell.title = entry["√âtat de Floraison"];
        }
        // Actions
        const actionsCell = row.insertCell();
        actionsCell.classList.add('action-buttons');
        const editBtn = document.createElement('button');
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.title = 'Modifier';
        editBtn.classList.add('edit-btn');
        editBtn.onclick = () => { showTab('map'); loadEntryForEdit(entry.id); };
        actionsCell.appendChild(editBtn);
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.title = 'Supprimer';
        deleteBtn.classList.add('delete-btn');
        deleteBtn.onclick = async function deleteEntry(id) {
            if (confirm('Supprimer cette entr√©e ?')) {
                await deleteEntryFromSheetDB(id);
                await loadEntriesFromSheetDB();
                renderTable();
                renderMapMarkers();
            }
        }.bind(null, entry.id);
        actionsCell.appendChild(deleteBtn);
    });
}

// --- MAP RENDERING ---
function formatDateFR(dateStr) {
    if (!dateStr) return '';
    const [yyyy, mm, dd] = dateStr.split('-');
    if (yyyy && mm && dd) return `${dd}-${mm}-${yyyy}`;
    return dateStr;
}

function renderMapMarkers(data) {
    data = data || filteredData || orchidData;

            markersLayer.clearLayers();
            data.forEach(entry => {
                // N'affiche la popup image que si la photo existe localement
                let popupContent = `<b>${entry.espece || ''}</b><br><span style='color:#b03a7a;font-weight:bold;'>${entry.commune || entry.Commune || 'Commune inconnue'}</span><br>${formatDateFR(entry.date) || ''}<br>Lat: ${(typeof entry.lat === 'number' && !isNaN(entry.lat)) ? entry.lat.toFixed(5) : ''}, Lon: ${(typeof entry.lon === 'number' && !isNaN(entry.lon)) ? entry.lon.toFixed(5) : ''}<br>√âtat de Floraison: ${entry["√âtat de Floraison"] || 'Aucune'}<br>Pieds: ${entry["Pieds"] || 'Non renseign√©'}`;
                if (entry.photoURL) {
                    popupContent += `<br><img src=\"${entry.photoURL}\" alt=\"Photo de ${entry.espece || ''}\" class=\"popup-image\">`;
                }
                if (typeof entry.lat === 'number' && typeof entry.lon === 'number' && !isNaN(entry.lat) && !isNaN(entry.lon)) {
                    const marker = L.marker([entry.lat, entry.lon], { icon: pinkDotIcon }).addTo(markersLayer);
                    marker.bindPopup(popupContent);
                }
            });
        }

        // --- EDIT AND DELETE FUNCTIONS ---
        function loadEntryForEdit(id) {
    const entry = orchidData.find(e => e.id === id);
    if (entry) {
        document.getElementById('latitude').value = entry.lat;
        document.getElementById('longitude').value = entry.lon;
        document.getElementById('date').value = entry.date;
        document.getElementById('species').value = entry.espece;
        document.getElementById('√âtat de Floraison').value = entry["√âtat de Floraison"] || '';
        document.getElementById('Pieds').value = entry["Pieds"] || '';
        document.getElementById('entry-id').value = entry.id;
        document.getElementById('commune').value = entry.commune || entry.Commune || '';
        // Afficher la photo d'origine si pr√©sente
        if (entry.photoDataURL) {
            photoPreview.src = entry.photoDataURL;
            photoPreview.style.display = 'block';
            photoDataURLInput.value = entry.photoDataURL;
            clearPhotoButton.style.display = 'inline-block';
            window.photoDataURL = entry.photoDataURL;
            window.photoDeleted = false;
        } else if (entry.photoURL) {
            photoPreview.src = entry.photoURL;
            photoPreview.style.display = 'block';
            photoDataURLInput.value = '';
            clearPhotoButton.style.display = 'inline-block';
            window.photoDataURL = '';
            window.photoDeleted = false;
        } else {
            resetPhotoFields();
            window.photoDataURL = '';
            window.photoDeleted = false;
        }
        form.querySelector('button[type="submit"]').textContent = 'Modifier l\'Observation';
        editingEntryId = entry.id;
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

        // --- CHARGEMENT DES DONN√âES DEPUIS SHEETDB ---
const SHEETDB_URL = 'https://sheetdb.io/api/v1/t1auyc7jcnz36'; // Nouvelle URL SheetDB de l'utilisateur

async function loadEntriesFromSheetDB() {
    try {
        const response = await fetch(SHEETDB_URL);
        const data = await response.json();
        console.log("R√©ponse SheetDB brute :", data);
        // Adapter selon la structure r√©elle des donn√©es re√ßues
        orchidData = Array.isArray(data) ? data.map(entry => ({
    id: entry.ID,
    genre: entry.Genre || '',
    espece: entry.Espece,
    date: entry.Date,
    lat: entry.Latitude ? parseFloat(String(entry.Latitude).replace(',', '.')) : undefined,
    lon: entry.Longitude ? parseFloat(String(entry.Longitude).replace(',', '.')) : undefined,
    Commune: entry.Commune || '',
    Pieds: entry.Pieds || '',
    "√âtat de Floraison": entry["√âtat de Floraison"] || entry.Etat_de_Floraison || '',
    photoURL: entry.PhotoURL
})) : [];
filteredData = orchidData;
        console.log("orchidData apr√®s parsing :", orchidData);
    } catch (err) {
        console.error("Erreur lors du chargement des donn√©es SheetDB :", err);
        orchidData = [];
    }
}

        // --- AJOUT DE DONN√âES DANS SHEETDB ---
        async function addEntryToSheetDB(entry) {
            // SheetDB attend des champs avec la casse exacte de la feuille Google Sheets
    const payload = {
        ID: entry.id,
        Genre: entry.genre,
        Espece: entry.espece,
        Date: entry.date,
        Latitude: entry.lat,
        Longitude: entry.lon,
        Commune: entry.commune,
        Note: entry.notes,
        PhotoURL: entry.photoURL
    };
            try {
                const response = await fetch(SHEETDB_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: [payload] })
                });
                if (!response.ok) throw new Error('Erreur lors de l‚Äôajout dans SheetDB');
            } catch (err) {
                alert("Erreur lors de l'enregistrement dans SheetDB : " + err.message);
                throw err;
            }
        }

        // --- MISE √Ä JOUR D'UNE ENTR√âE DANS SHEETDB ---
        async function updateEntryInSheetDB(entry) {
            // SheetDB met √† jour via PATCH sur /search
            const payload = {
                ID: entry.id,
                Espece: entry.espece,
                Date: entry.date,
                Latitude: entry.lat,
                Longitude: entry.lon,
                Commune: entry.commune,
                Note: entry.notes,
                PhotoURL: entry.photoURL
            };
            try {
                const response = await fetch(`${SHEETDB_URL}/ID/${encodeURIComponent(entry.id)}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: payload })
                });
                if (!response.ok) throw new Error('Erreur lors de la mise √† jour dans SheetDB');
            } catch (err) {
                alert("Erreur lors de la mise √† jour dans SheetDB : " + err.message);
                throw err;
            }
        }

        // --- SUPPRESSION D'UNE ENTR√âE DANS SHEETDB ---
        async function deleteEntryFromSheetDB(id) {
            try {
                const response = await fetch(`${SHEETDB_URL}/ID/${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                });
                if (!response.ok) throw new Error('Erreur lors de la suppression dans SheetDB');
            } catch (err) {
                alert("Erreur lors de la suppression dans SheetDB : " + err.message);
                throw err;
            }
        }

        // --- INITIAL LOAD ---
        async function initializeApp() {
            await loadEntriesFromSheetDB();
            renderTable(filteredData);
            renderMapMarkers(filteredData);
            resetPhotoFields(); // Ensure photo fields are clear on initial load
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    // Affichage initial : tout afficher
    renderTable(filteredData);
    renderMapMarkers(filteredData);


    </script>
</body>
</html>
